<!DOCTYPE html>
<!-- This file is inlined and stored in the final binary -->
<!-- TODO: Add support for binary data -->
<html>

<head>
	<meta charset="utf-8">
	<title>WebSocket Test</title>
	<style>
		* {
			font-family: sans-serif;
			box-sizing: border-box;
			font-size: 14px;
		}

		.container {
			display: flex;
		}

		.flex-row {
			flex-flow: row nowrap;
			align-items: stretch;
		}

		.flex-col {
			flex-flow: column nowrap;
			align-items: stretch;
		}

		textarea {
			margin: 5px;
		}

		#data {
			flex-grow: 2;
		}

		#msgLogDiv {
			flex-basis: 40%
		}

		.flex-grow0 {
			flex-grow: 0;
		}

		.flex-grow1 {
			flex-grow: 1;
		}

		p#received {
			height: 400px;
		}

		.log {
			margin: 5px;
		}

		.messaging {
			height: 300px;
		}

		.scroll {
			overflow: scroll;
		}
	</style>
</head>

<body>
	<script>
		let __WS_PORT__ = 8081;
		let socket = new WebSocket("ws://127.0.0.1:${wsp}".replace("${wsp}", __WS_PORT__), "websocket-serial-json");

		// Websocket message handler
		socket.onmessage = (event) => {
			try {
				let obj = JSON.parse(event.data);
				if (obj["Read"] !== undefined) {
					let received = document.getElementById("received");
					let br = document.createElement("BR");
					let text = document.createTextNode(event.data);
					received.insertBefore(br, received.firstChild);
					received.insertBefore(text, received.firstChild);
				} else {
					let log = document.getElementById("msgLog");
					let br = document.createElement("BR");
					let text = document.createTextNode(event.data);
					log.insertBefore(br, log.firstChild);
					log.insertBefore(text, log.firstChild);
				}
			} catch (e) {
				Console.log("Error handling ws message", e);
			}
		};

		// Close Port
		function closePort(event) {
			let portName = document.getElementById("serialPort").value;
			let msg = {
				"Close": {
					"port": portName
				}
			};
			socket.send(JSON.stringify(msg));
			return false;
		}

		// OpenPort 
		function openPort(event) {
			let portName = document.getElementById("serialPort").value;
			let msg = {
				"Open": {
					"port": portName
				}
			};
			socket.send(JSON.stringify(msg));
			return false;
		}

		// ListPorts 
		function listPorts(event) {
			let msg = {
				"List": {}
			};
			socket.send(JSON.stringify(msg));
			return false;
		}

		// LockPort
		function lockPort(event) {
			let portName = document.getElementById("serialPort").value;
			let msg = {
				"WriteLock": {
					"port": portName
				}
			};
			socket.send(JSON.stringify(msg));
			return false;
		}

		// UnlockPort
		function unlockPort(event) {
			let portName = document.getElementById("serialPort").value;
			let msg = {
				"ReleaseWriteLock": {
					"port": portName
				}
			};
			socket.send(JSON.stringify(msg));
			return false;
		}

		// WriteData 
		function writeData(event) {
			let portName = document.getElementById("serialPort").value;
			let data = document.getElementById("data").value;
			let msg = {
				"Write": {
					"port": portName,
					"data": data
				}
			}
			socket.send(JSON.stringify(msg));
			return false;
		}

		// Clear read data view 
		function clearReadData(event) {
			document.getElementById("received").innerHTML = '';
			return false;
		}

		// Clear Msg Log 
		function clearMsgLog(event) {
			document.getElementById("msgLog").innerHTML = '';
			return false;
		}
	</script>
	<button type="button" onclick="listPorts(event);">List Ports</button>
	<br>
	<br>
	<label>Serial Port:&nbsp;<input type="text" id="serialPort"></label>
	<button type="button" onclick="openPort(event);">Open</button>
	<button type="button" onclick="closePort(event);">Close</button>
	<button type="button" onclick="lockPort(event);">Write Lock</button>
	<button type="button" onclick="unlockPort(event);">Release Lock</button>
	<br>
	<br>
	<div class="container flex-row messaging">
		<textarea id="data"></textarea>
		<div id="msgLogDiv" class="container flex-col">
			<div class="flex-grow0">
				<strong>Command Replies:</strong>&nbsp;
				<button type="button" onclick="clearMsgLog(event);">Clear</button>
			</div>
			<div class="flex-grow1 scroll">
				<p class="log" id="msgLog"></p>
			</div>
		</div>
	</div>
	<br>
	<button type="button" onclick="writeData(event);">Write Data</button>
	<br>
	<br>
	<strong>Data Read:</strong> &nbsp;
	<button type="button" onclick="clearReadData();">Clear</button>
	<p class="log" id="received">
	</p>
</body>

</html>